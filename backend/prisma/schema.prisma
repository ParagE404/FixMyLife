// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// AUTH & USER MODELS
// ============================================

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String // bcrypt hashed
  name                 String
  avatar               String? // Gravatar URL or initials
  timezone             String    @default("UTC")
  onboardingCompleted  Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  lastLoginAt          DateTime?

  // Relations
  activities          Activity[]
  customCategories    CustomCategory[]
  sessionTokens       SessionToken[]
  notifications       Notification[]
  preferences         UserPreferences?
  activitySuggestions ActivitySuggestion[]
  goals               Goal[]
  insights            Insight[]
  patterns            UserPatterns?
  patternSuggestions  PatternSuggestion[]
  correlationAnalysis CorrelationAnalysis?

  @@index([email])
}

model SessionToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model UserPreferences {
  id                   String   @id @default(cuid())
  userId               String   @unique
  rememberMeEnabled    Boolean  @default(true)
  notificationsEnabled Boolean  @default(true)
  dailyReminders       Boolean  @default(true)
  weeklyReports        Boolean  @default(true)
  goalAchievements     Boolean  @default(true)
  streakAlerts         Boolean  @default(false)
  emailNotifications   Boolean  @default(false)
  theme                String   @default("system") // light, dark, system
  accentColor          String   @default("green") // green, blue, purple, orange
  categoryOrder        String[] @default([]) // JSON array of category IDs
  hiddenCategories     String[] @default([]) // Categories hidden from UI
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// CATEGORIES & CUSTOM CATEGORIES
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique // "Physical Health", "Career & Finances", etc.
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  activities Activity[]
  goals      Goal[]

  @@index([name])
}

model CustomCategory {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities Activity[]
  goals      Goal[]

  @@unique([userId, name])
  @@index([userId])
}

// ============================================
// ACTIVITY MODELS
// ============================================

model Activity {
  id               String    @id @default(cuid())
  userId           String
  description      String
  categoryId       String
  customCategoryId String?
  startTime        DateTime
  endTime          DateTime?
  duration         Int? // in minutes
  confidenceScore  Float     @default(0.0) // 0-100
  parsedData       Json? // Raw LLM output for debugging
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category       Category        @relation(fields: [categoryId], references: [id])
  customCategory CustomCategory? @relation(fields: [customCategoryId], references: [id])
  // @@fulltext([description]) // PostgreSQL full-text search

  @@index([userId])
  @@index([categoryId])
  @@index([customCategoryId])
  @@index([startTime])
  @@index([createdAt])
}

model ActivitySuggestion {
  id          String    @id @default(cuid())
  userId      String
  description String
  categoryId  String
  frequency   Int       @default(1) // times logged
  lastUsed    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([frequency])
}

// ============================================
// GOALS
// ============================================

model Goal {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  targetHours Float // Hours per week
  goalType    String    @default("habit") // "habit", "milestone", "challenge"
  category    Category? @relation(fields: [categoryId], references: [id])
  categoryId  String?

  startDate DateTime
  endDate   DateTime?
  status    String    @default("active") // active, completed, abandoned

  progress GoalProgress[]

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  customCategory   CustomCategory? @relation(fields: [customCategoryId], references: [id])
  customCategoryId String?
}

model GoalProgress {
  id     String @id @default(cuid())
  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)

  date        DateTime
  hoursLogged Float

  createdAt DateTime @default(now())
}

model Insight {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     String // "milestone", "trend", "recommendation", "warning"
  title    String
  message  String
  metadata Json? // Store extra data (old value, new value, etc)

  isRead Boolean @default(false)

  createdAt DateTime @default(now())
}

// ============================================
// NOTIFICATIONS & ALERTS
// ============================================

model Notification {
  id         String   @id @default(cuid())
  userId     String
  type       String // "streak", "milestone", "goal_alert", "recommendation"
  title      String
  message    String
  actionData Json? // Extra context (e.g., { goalId: "..." })
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// STREAKS & MILESTONES
// ============================================

model Streak {
  id               String   @id @default(cuid())
  userId           String
  categoryId       String?
  customCategoryId String?
  currentCount     Int      @default(1)
  bestCount        Int      @default(1)
  lastActivityDate DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([userId, categoryId, customCategoryId])
  @@index([userId])
}

model Milestone {
  id            String    @id @default(cuid())
  userId        String
  milestoneType String // "logging_7day", "activities_100", "exercise_doubled", etc.
  achieved      Boolean   @default(false)
  achievedAt    DateTime?
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([achieved])
}

// ============================================
// ANALYTICS & AGGREGATIONS
// ============================================

model DailyAggregate {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime // date only (YYYY-MM-DD)
  totalActivities   Int      @default(0)
  totalDuration     Int      @default(0) // minutes
  categoryBreakdown Json // { "categoryId": hours, ... }
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model WeeklyAggregate {
  id                String   @id @default(cuid())
  userId            String
  weekStart         DateTime // Monday of week
  totalHours        Int      @default(0)
  categoryBreakdown Json // { "categoryId": hours, ... }
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
}

// ============================================
// BEHAVIORAL PATTERN RECOGNITION
// ============================================

model UserPatterns {
  id           String   @id @default(cuid())
  userId       String   @unique
  patterns     Json     // Stores detected patterns (daily, weekly, category, temporal)
  lastAnalyzed DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastAnalyzed])
}

model PatternSuggestion {
  id          String   @id @default(cuid())
  userId      String
  type        String   // 'habit_resumption', 'upcoming_habit', 'sequence_suggestion', 'weekly_habit'
  category    String
  title       String
  message     String
  priority    String   // 'high', 'medium', 'low'
  confidence  Float
  timing      String   // 'immediate', 'upcoming', 'sequence', 'weekly'
  actionType  String   // 'log_activity', 'prepare_activity', 'reminder'
  isRead      Boolean  @default(false)
  isActedOn   Boolean  @default(false)
  createdAt   DateTime @default(now())
  expiresAt   DateTime // Suggestions expire after some time

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([isRead])
}

model CorrelationAnalysis {
  id           String   @id @default(cuid())
  userId       String   @unique
  correlations Json     // Array of correlation objects
  insights     Json     // Array of insight objects
  predictions  Json     // Array of prediction objects
  dataPoints   Int      @default(0)
  lastAnalyzed DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastAnalyzed])
}

// ============================================
// SEED DATA MODELS (for demo user)
// ============================================

model DemoSeed {
  id       String   @id @default(cuid())
  seedDate DateTime @default(now())
  // tracks if demo data was already seeded
}
